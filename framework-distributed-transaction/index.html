<!DOCTYPE html><html lang="ja、zh-CN、zh-HK、zh-TW、en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#FFF"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png"><link rel="icon" type="image/ico" sizes="32x32" href="/images/favicon.ico"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="alternate" type="application/rss+xml" title="冴羽　逸秋" href="https://blog.issyuu.com/rss.xml"><link rel="alternate" type="application/atom+xml" title="冴羽　逸秋" href="https://blog.issyuu.com/atom.xml"><link rel="alternate" type="application/json" title="冴羽　逸秋" href="https://blog.issyuu.com/feed.json"><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Mulish:300,300italic,400,400italic,700,700italic%7CFredericka%20the%20Great:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20JP:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20SC:300,300italic,400,400italic,700,700italic%7CInconsolata:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext"><link rel="stylesheet" href="/css/app.css?v=0.2.5"><meta name="keywords" content="framework"><link rel="canonical" href="https://blog.issyuu.com/framework-distributed-transaction/"><title>分布式事务总结 - 总结 - 技术 | 湖心小筑 = 冴羽　逸秋 = 欲を捨てて、今を生きる！</title><meta name="generator" content="Hexo 5.4.2"></head><body itemscope itemtype="http://schema.org/WebPage"><div id="loading"><div class="cat"><div class="body"></div><div class="head"><div class="face"></div></div><div class="foot"><div class="tummy-end"></div><div class="bottom"></div><div class="legs left"></div><div class="legs right"></div></div><div class="paw"><div class="hands left"></div><div class="hands right"></div></div></div></div><div id="container"><header id="header" itemscope itemtype="http://schema.org/WPHeader"><div class="inner"><div id="brand"><div class="pjax"><h1 itemprop="name headline">分布式事务总结</h1><div class="meta"><span class="item" title="Created: 2019-05-25 00:00:00"><span class="icon"><i class="ic i-calendar"></i> </span><span class="text">Posted on</span> <time itemprop="dateCreated datePublished" datetime="2019-05-25T00:00:00+09:00">2019-05-25</time> </span><span class="item" title="Symbols count in article"><span class="icon"><i class="ic i-pen"></i> </span><span class="text">Symbols count in article</span> <span>3.8k</span> <span class="text">words</span> </span><span class="item" title="Reading time"><span class="icon"><i class="ic i-clock"></i> </span><span class="text">Reading time</span> <span>3 mins.</span></span></div></div></div><nav id="nav"><div class="inner"><div class="toggle"><div class="lines" aria-label="Toggle navigation bar"><span class="line"></span> <span class="line"></span> <span class="line"></span></div></div><ul class="menu"><li class="item title"><a href="/" rel="start">湖心小筑</a></li></ul><ul class="right"><li class="item theme"><i class="ic i-sun"></i></li><li class="item search"><i class="ic i-search"></i></li></ul></div></nav></div><div id="imgs" class="pjax"><ul><li class="item" data-background-image="https://cdn.jsdelivr.net/gh/smile-lxy/resources@latest/images/random/0a6be1d1fa7827fc28504c63a5a6d653.md.jpg"></li><li class="item" data-background-image="https://cdn.jsdelivr.net/gh/smile-lxy/resources@latest/images/random/5e31374bf28e62a34775694f9acb06a9.md.jpg"></li><li class="item" data-background-image="https://cdn.jsdelivr.net/gh/smile-lxy/resources@latest/images/random/2b0a8c81d91579602eee343aff82c4c9.md.jpg"></li><li class="item" data-background-image="https://cdn.jsdelivr.net/gh/smile-lxy/resources@latest/images/random/8a8076ea9cbc7d677dd42ad84d4e3ebd.md.jpg"></li><li class="item" data-background-image="https://cdn.jsdelivr.net/gh/smile-lxy/resources@latest/images/random/c50475797549951523025a46bab169bb.md.jpg"></li><li class="item" data-background-image="https://cdn.jsdelivr.net/gh/smile-lxy/resources@latest/images/random/7ab81e5e45a86caec012652e2595d6d5.md.jpg"></li></ul></div></header><div id="waves"><svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z"/></defs><g class="parallax"><use xlink:href="#gentle-wave" x="48" y="0"/><use xlink:href="#gentle-wave" x="48" y="3"/><use xlink:href="#gentle-wave" x="48" y="5"/><use xlink:href="#gentle-wave" x="48" y="7"/></g></svg></div><main><div class="inner"><div id="main" class="pjax"><div class="article wrap"><div class="breadcrumb" itemscope itemtype="https://schema.org/BreadcrumbList"><i class="ic i-home"></i> <span><a href="/">Home</a></span><i class="ic i-angle-right"></i> <span itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/%E6%8A%80%E6%9C%AF/" itemprop="item" rel="index" title="In 技术"><span itemprop="name">技术</span></a><meta itemprop="position" content="1"></span><i class="ic i-angle-right"></i> <span class="current" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/%E6%8A%80%E6%9C%AF/%E6%80%BB%E7%BB%93/" itemprop="item" rel="index" title="In 总结"><span itemprop="name">总结</span></a><meta itemprop="position" content="2"></span></div><article itemscope itemtype="http://schema.org/Article" class="post block" lang="ja、zh-CN、zh-HK、zh-TW、en"><link itemprop="mainEntityOfPage" href="https://blog.issyuu.com/framework-distributed-transaction/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.jpg"><meta itemprop="name" content="冴羽　逸秋"><meta itemprop="description" content="欲を捨てて、今を生きる！, 欲を捨てて、今を生きる！"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="冴羽　逸秋"></span><div class="body md" itemprop="articleBody"><ul><li>好记性不如烂笔头.<br><span id="more"></span></li></ul><h3 id="前言"><a class="anchor" href="#前言">#</a> 前言</h3><ul><li>在当下微服务盛行时代，随着单体应用根据业务拆分为多个应用，虽提高了可用性等优势，但成本，事务等问题也凸显了出来</li></ul><h3 id="正文"><a class="anchor" href="#正文">#</a> 正文</h3><ul><li>本地事务<ul><li>把一个数据库内部的事务处理，如对多个表的操作，作为本地事务看待；</li></ul></li><li>分布式事务 (全局事务)<ul><li>多个数据库可能需要共同完成一个工作；</li></ul></li></ul><h4 id="两阶段提交2pc"><a class="anchor" href="#两阶段提交2pc">#</a> 两阶段提交 (2PC)</h4><ul><li>保证分布式事务的原子性；</li><li>两阶段分别指: <code>准备</code> ， <code>提交</code> ；</li><li>参与者将操作成败通知协调者，再由协调者根据所有参与者的反馈情报决定各参与者是否要提交操作还是中止操作</li></ul><h5 id="准备"><a class="anchor" href="#准备">#</a> 准备</h5><ul><li>事务协调者 (事务管理器) 给每个参与者 (资源管理器) 发送<strong>准备</strong> (Prepare) 消息，参与者返回失败或执行本地事务 (写本地的 Redo (物理<span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM4MTI1MTgzL2FydGljbGUvZGV0YWlscy84MDY1MjU1Nw==">日志</span>) 和 Undo (逻辑日志), 但不提交 (万事俱备，只欠东风的状态));<ul><li><strong>协调者</strong>向各<strong>参与者</strong>发起 <code>询问</code> 是否可以执行提交操作，同步等待各<strong>参与者</strong>响应；</li><li>各<strong>参与者</strong>执行到 <code>询问</code> 为止的所有事务操作，并将 Undo 信息和 Redo 信息写入日志 (!: 若成功，这一步各<strong>参与者</strong>其实已执行了事务操作).</li><li>各<strong>参与者</strong>响应<strong>协调者</strong>的 <code>询问</code> 指令，如果各<strong>参与者</strong>的事务操作已执行成功，则返回‘同意’, 如果有<strong>参与者</strong>的事务操作执行失败，则返回‘中止’;</li></ul></li></ul><h5 id="提交"><a class="anchor" href="#提交">#</a> 提交</h5><ul><li><strong>协调者</strong>根据<strong>参与者</strong>的反应情况来决定是否继续事务的 <code>Commit</code> 请求或者 <code>Abort</code> 请求。各<strong>参与者</strong>根据<strong>协调者</strong>的 <code>指令</code> 执行‘Commit’或‘Abort‘操作，释放所有事务处理过程中使用的 ' 锁资源 '(!: 必须在最后阶段释放锁资源).<ul><li><p>同意</p><ul><li><strong>协调者</strong>从各<strong>参与者</strong>收到的响应均是‘同意’;<ol><li><strong>发送提交请求</strong>: <strong>协调者</strong>向各<strong>参与者</strong>发送 <code>Commit</code> 请求；</li><li><strong>事务提交</strong>: <strong>参与者</strong>收到 <code>Commit</code> 指令后，正式完成操作，释放在整个事务期间占用的资源；</li><li><strong>反馈结果</strong>: <strong>参与者</strong>完成 <code>Commit</code> 后，向<strong>协调者</strong>发送‘ACK’响应；</li><li><strong>完成事务</strong>: <strong>协调者</strong>收到各<strong>参与者</strong>反馈的‘ACK’消息后，完成事务；</li></ol></li></ul></li><li><p>中止</p><ul><li><strong>协调者</strong>从某<strong>参与者</strong>收到的响应是‘中止’或者<strong>协调者</strong>在 <code>询问</code> 后，超时之前无法得到所有<strong>参与者</strong>的响应；<ol><li><strong>发送中断请求</strong>: <strong>协调者</strong>向各<strong>参与者</strong>发送 <code>Abort</code> 请求</li><li><strong>事务回滚</strong>: <strong>参与者</strong>收到 <code>Abort</code> 指令后，利用之前写入的 Undo 信息执行 <code>回滚</code> ，释放在整个事务期间占用的资源；</li><li><strong>反馈结果</strong>: <strong>参与者</strong>完成 <code>回滚</code> 后，向<strong>协调者</strong>发送‘ACK’响应；</li><li><strong>中断事务</strong>: <strong>协调者</strong>收到各<strong>参与者</strong>反馈的‘ACK’消息后，执行事务的中断；</li></ol></li></ul></li></ul></li><li>不论结果如何， <code>提交</code> 阶段都会结束当前事务.</li></ul><h5 id="缺点"><a class="anchor" href="#缺点">#</a> 缺点</h5><ul><li><strong>同步阻塞</strong>，执行过程中，各<strong>参与者</strong>都是事务阻塞型的。当<strong>参与者</strong>占用公共资源时，其他节点访问公共资源就不得不处于‘阻塞’状态；</li><li><strong>单点故障</strong>，<strong>协调者</strong>的重要性，如果<strong>协调者</strong>发生故障，<strong>参与者</strong>将一直阻塞下去，尤其在 <code>提交</code> 阶段，<strong>协调者</strong>发生故障，各<strong>参与者</strong>还都处于‘锁定事务资源’状态中，无法继续完成事务操作.(<strong>协调者</strong>挂掉，可重新选举一个<strong>协调者</strong>，但无法解决因<strong>协调者</strong>故障导致的<strong>参与者</strong>处于‘阻塞’状态的问题);</li><li><strong>数据不一致</strong>，在 <code>提交</code> 阶段，<strong>协调者</strong>向各<strong>参与者</strong>发送 <code>正式提交</code> (Commit) 请求后，发生‘局部网络异常’或<strong>协调者</strong>发生‘故障’, 将导致一部分<strong>参与者</strong>接受了 <code>正式提交</code> (Commit) 请求，这些<strong>参与者</strong>将正常执行，但其余<strong>参与者</strong>因未收到 <code>正式提交</code> (Commit) 请求而无法执行‘事务提交’, 结果便是分布式系统出现‘数据不一致’现象；</li><li>协议成本高，存在全局锁问题；</li></ul><h5 id="无法解决的问题"><a class="anchor" href="#无法解决的问题">#</a> 无法解决的问题</h5><ul><li><strong>协调者</strong>在发出 <code>正式提交</code> (Commit) 请求后宕机，而收到‘请求’的<strong>参与者</strong>也同时宕机，那么即使协调者通过选举产生新的<strong>协调者</strong>，这个事务的状态也将是不确定的，没人知道是否已提交；</li></ul><h5 id="结果"><a class="anchor" href="#结果">#</a> 结果</h5><ul><li>两阶段提交存在着同步阻塞，单点故障，脑裂等缺陷；</li></ul><h4 id="三阶段提交3pc"><a class="anchor" href="#三阶段提交3pc">#</a> 三阶段提交 (3PC)</h4><ul><li>两阶段提交的改进版本；</li></ul><h5 id="区别"><a class="anchor" href="#区别">#</a> 区别</h5><ul><li>引入超时机制 (<strong>协调者</strong>和<strong>参与者</strong>都引入超时机制);</li><li>在第一阶段和第二阶段中插入一个准备阶段，保证在最后 <code>提交</code> 阶段之前各<strong>参与者</strong>状态一致；</li></ul><h5 id="cancommit"><a class="anchor" href="#cancommit">#</a> CanCommit</h5><ul><li><strong>协调者</strong>向各<strong>参与者</strong>发送 <code>CanCommit</code> 请求；<ul><li><strong>事务询问</strong>: <strong>协调者</strong>向各<strong>参与者</strong>发送 <code>CanCommit</code> 请求，询问是否可以执行 <code>提交</code> (Commit) 操作，然后等待各<strong>参与者</strong>响应；</li><li><strong>响应反馈</strong>: <strong>参与者</strong>收到 <code>CanCommit</code> 请求后，正常情况下，如果其自身认为可以顺利执行事务，则返回‘同意’, 并进去预备状态；反之返回‘中止’;</li></ul></li></ul><h5 id="precommit"><a class="anchor" href="#precommit">#</a> PreCommit</h5><ul><li><strong>协调者</strong>根据<strong>参与者</strong>的反应情况来决定是否可以继续事务的 <code>PreCommit</code> 请求<ul><li>同意<ul><li><strong>协调者</strong>从各<strong>参与者</strong>收到的响应均是‘同意’;<ol><li><strong>发起预提交</strong>: <strong>协调者</strong>向<strong>参与者</strong>发送 <code>PreCommit</code> 请求，并进入 Prepared 阶段；</li><li><strong>事务预提交</strong>：各<strong>参与者</strong>收到 <code>PreCommit</code> 指令后，执行事务操作，并将 Undo 和 Redo 信息记录到日志中；</li><li><strong>响应反馈</strong>：各<strong>参与者</strong>成功执行了事务操作，返回 ACK 响应，等待最终指令；</li></ol></li></ul></li><li>中止<ul><li><strong>协调者</strong>从某<strong>参与者</strong>收到的响应是‘中止’或者<strong>协调者</strong>在 <code>PreCommit</code> 请求后，超时之前无法得到所有<strong>参与者</strong>的响应；<ol><li><strong>发送中断请求</strong>: <strong>协调者</strong>向<strong>参与者</strong>发送 <code>Abort</code> 请求；</li><li><strong>中断事务</strong>：各<strong>参与者</strong>收到 <code>Abort</code> 指令后 (或超时后，仍未收到<strong>协调者</strong>的请求), 执行事务中断；</li></ol></li></ul></li></ul></li></ul><h5 id="docommit"><a class="anchor" href="#docommit">#</a> DoCommit</h5><ul><li>真正的事务提交，分两种情况；<ul><li>执行提交<ol><li><strong>发送提交请求</strong>: <strong>协调者</strong>收到各<strong>参与者</strong>的 ACK 响应后，<strong>协调者</strong>将从‘预提交’进入到‘提交’状态，向各<strong>参与者</strong>发送 <code>Commit</code> 请求；</li><li><strong>事务提交</strong>: <strong>参与者</strong>收到 <code>Commit</code> 指令后，正式完成操作，释放在整个事务期间占用的资源；</li><li><strong>反馈结果</strong>: <strong>参与者</strong>完成 <code>Commit</code> 后，向<strong>协调者</strong>发送‘ACK’响应；</li><li><strong>完成事务</strong>: <strong>协调者</strong>收到各<strong>参与者</strong>反馈的‘ACK’消息后，完成事务；</li></ol></li><li>中断事务<ol><li><strong>发送中断请求</strong>: <strong>协调者</strong>向各<strong>参与者</strong>发送 <code>Abort</code> 请求；</li><li><strong>事务回滚</strong>: <strong>参与者</strong>收到 <code>Abort</code> 指令后，利用之前写入的 Undo 信息执行 <code>回滚</code> ，释放在整个事务期间占用的资源；</li><li><strong>反馈结果</strong>: <strong>参与者</strong>完成 <code>回滚</code> 后，向<strong>协调者</strong>发送‘ACK’响应；</li><li><strong>中断事务</strong>: <strong>协调者</strong>收到各<strong>参与者</strong>反馈的‘ACK’消息后，执行事务的中断；</li></ol></li></ul></li></ul><h5 id="注意"><a class="anchor" href="#注意">#</a> 注意</h5><ul><li><code>DoCommit</code> 阶段，若<strong>参与者</strong>无法及时收到来自<strong>协调者</strong>的 <code>Commit</code> 或 <code>Abort</code> 请求是，超时后会自动进行 <code>Commit</code> 操作.</li></ul><hr><h5 id="2pc与3pc区别"><a class="anchor" href="#2pc与3pc区别">#</a> 2PC 与 3PC 区别</h5><ul><li>3PC 主要解决 2PC 的单点故障，同步阻塞问题。因<strong>参与者</strong>无法及时收到<strong>协调者</strong>的请求后会默认 <code>Commit</code> , 而不会一直持有事务资源并处于‘阻塞状态’, 但这种机制有时也会导致<strong>数据一致性</strong>问题 (因网络等其他情况，<strong> 协调者</strong>发送 <code>Abort</code> 请求没有及时被<strong>参与者</strong>接受到，那么<strong>参与者</strong>在等待超时后执行了 <code>Commit</code> 指令，这样就和其他<strong>参与者</strong>之间存在<strong>数据不一致性</strong>问题);</li></ul><h4 id="base"><a class="anchor" href="#base">#</a> BASE</h4><ul><li>各<strong>参与者</strong>不一定同时在线，允许系统状态更新延迟，这个延迟对客户来说不一定能察觉，实现最终一致性.</li></ul><h4 id="tcc"><a class="anchor" href="#tcc">#</a> TCC</h4><ul><li>基于两阶段提交的分布式事务实现方案</li></ul><h5 id="try"><a class="anchor" href="#try">#</a> Try</h5><ul><li>尝试执行业务</li><li>完成所有业务检查，预留必要的业务资源</li></ul><h5 id="confirm"><a class="anchor" href="#confirm">#</a> Confirm</h5><ul><li>确认执行业务</li><li>真正执行业务，不做业务检查</li></ul><h5 id="cancel"><a class="anchor" href="#cancel">#</a> Cancel</h5><ul><li>取消执行业务</li><li>释放 Try 阶段预留的业务资源</li></ul><h5 id="2pc与tcc区别"><a class="anchor" href="#2pc与tcc区别">#</a> 2PC 与 TCC 区别</h5><ul><li>TCC 位于业务服务层，没有单独的准备阶段，Try 操作可以灵活的选择业务资源锁的粒度；</li><li>TCC 通过最终一致性来解决系统性能问题；</li></ul><h5 id="优点"><a class="anchor" href="#优点">#</a> 优点</h5><ul><li>隔离型高</li></ul><h5 id="缺点-2"><a class="anchor" href="#缺点-2">#</a> 缺点</h5><ul><li>增大编码量</li></ul><h5 id="适用场景"><a class="anchor" href="#适用场景">#</a> 适用场景</h5><ul><li>基础服务</li><li>中台服务</li></ul><h4 id="saga"><a class="anchor" href="#saga">#</a> Saga</h4><ul><li>长活事务，由多个‘本地事务 (sub-transaction Ti)’组成，每个‘本地事务’均有相应 <code>执行模块</code> ， <code>补偿模块</code> (Ci), 任意一个‘本地事务’出错，可通过调用对象补偿方法恢复，达到事务的最终一致性；</li></ul><h5 id="实现方式"><a class="anchor" href="#实现方式">#</a> 实现方式</h5><ol><li><strong>集中式</strong></li></ol><ul><li>通过一个 Saga 对象来追踪所有 Saga 子任务的调用情况，根据调用情况来决定是否需要调用对应的 ' 补偿模块 '(协调器和调用方在一个进程中).</li><li>集中式实现方式直观，容易控制。业务耦合度高；</li></ul><ol start="2"><li><strong>分布式</strong></li></ol><ul><li>采用 ' 事件驱动 ' 方式让各<strong>参与者</strong>进行相互交互，相关业务只需订阅相关领域事件即可.</li><li>分布式降低系统复杂程度，提高系统拓展性。如果<strong>参与者</strong>过多，会对编码，调试带来问题；业务逻辑是基于事件，有可能会有循环依赖的问题；</li></ul><h5 id="补偿策略"><a class="anchor" href="#补偿策略">#</a> 补偿策略</h5><ol><li><strong>向后恢复</strong> (backward recovery): 补偿所有已完成的事务。如果一 ' 本地事务 (j)' 失败，撤销之前所有已成功的 ' 本地事务 '(之前 Saga 所有执行结果撤销). (例：T1, T2, ..., Tj, Cj, ..., C2, C1 (0 &lt; j &lt; n))</li><li><strong>向前恢复</strong> (forward recovery): 重试失败的事务。使用于必须要成功的场景. (T1, T2, ..., <strong>Tj(fail)</strong>, <strong>Tj(retry)</strong>, Tj+1, ..., Tn)</li></ol><h5 id="acid"><a class="anchor" href="#acid">#</a> ACID</h5><ul><li>原子性：通过 'Saga 协调器 ' 实现；</li><li>一致性：通过 ' 本地事务 ' + 'Saga log' 保证；</li><li>隔离性：不保证；</li><li>持久性：通过 'Saga log' 保证；</li><li>总结: Saga 只支持 ACD, 不支持 I (隔离性) 的保证；</li></ul><h5 id="要求"><a class="anchor" href="#要求">#</a> 要求</h5><ul><li><strong>请求幂等</strong>：因网络请求等各种原因，服务间请求时会出现 ' 超时重试 ' 的情况，需要通过 ' 幂等 ' 来避免多次请求所带来的问题；</li><li><strong>事务数据</strong>:</li></ul><h5 id="注意-2"><a class="anchor" href="#注意-2">#</a> 注意</h5><ul><li>因 Saga 事务没有 ' 准备 ' 阶段，所以事务没有隔离，操作过程中若出现多 ' 本地事务 ' 同时操作一资源，有可能会出现数据语义不一致，更新丢失，脏读取，模糊读取等各种问题.<ul><li>可参考 TCC, 在业务层加入 Session, 锁机制来保证串行化操作资源；</li><li>业务层操作冻结 (隔离) 资源方式，保证各 ' 本地事务 ' 操作不至于影响其他 ' 本地事务 ';</li><li>业务操作过程中通过及时读取当前状态的方式获取到最新的更新；</li></ul></li></ul><h5 id="适用场景-2"><a class="anchor" href="#适用场景-2">#</a> 适用场景</h5><ul><li>其他组织业务</li><li>遗留系统</li></ul><h3 id="总结"><a class="anchor" href="#总结">#</a> 总结</h3><h4 id="微服务"><a class="anchor" href="#微服务">#</a> 微服务</h4><ul><li>服务内: <strong>内刚</strong>，通过数据库事务保证强一致性；</li><li>服务间: <strong>外柔</strong>，</li></ul><h3 id="引用"><a class="anchor" href="#引用">#</a> 引用</h3><ul><li><span class="exturl" data-url="aHR0cHM6Ly93d3cuY25ibG9ncy5jb20veGluZ3pjL3AvNTc0NTU4Ny5odG1s">两阶段提交协议、三阶提交协议</span></li><li><span class="exturl" data-url="aHR0cDovL3NlcnZpY2Vjb21iLmFwYWNoZS5vcmcvY24vZG9jcy9kaXN0cmlidXRlZC10cmFuc2FjdGlvbnMtc2FnYS1pbXBsZW1lbnRhdGlvbi8=">Saga 分布式事务解决方案与实践</span></li><li><span class="exturl" data-url="aHR0cHM6Ly9taWNyb3NlcnZpY2VzLmlvL3BhdHRlcm5zL2RhdGEvc2FnYS5odG1s">微服务架构 - Saga</span></li><li><span class="exturl" data-url="aHR0cHM6Ly93d3cuamlhbnNodS5jb20vcC83NWExNzc5YWU4NzA=">理解 TCC 分布式事务</span></li><li><span class="exturl" data-url="aHR0cHM6Ly9wYXRlbnRpbWFnZXMuc3RvcmFnZS5nb29nbGVhcGlzLmNvbS8wMS9iNS84YS9hYWEyZGZmMTFjOWMzOC9DTjEwNjg0NDAxNEEucGRm">阿里云 TCC 专利</span></li><li><span class="exturl" data-url="aHR0cHM6Ly96aHVhbmxhbi56aGlodS5jb20vcC8xMTc0NzY5NTk=">MYSQL 事务隔离级别</span></li></ul><div class="tags"><a href="/tags/framework/" rel="tag"><i class="ic i-tag"></i> framework</a></div></div><footer><div class="meta"><span class="item"><span class="icon"><i class="ic i-calendar-check"></i> </span><span class="text">Edited on</span> <time title="Modified: 2023-05-29 00:36:18" itemprop="dateModified" datetime="2023-05-29T00:36:18+09:00">2023-05-29</time> </span><span id="/framework-distributed-transaction/" class="item leancloud_visitors" data-flag-title="分布式事务总结" title="Views"><span class="icon"><i class="ic i-eye"></i> </span><span class="text">Views</span> <span class="leancloud-visitors-count"></span> <span class="text">times</span></span></div><div id="copyright"><ul><li class="author"><strong>Post author: </strong>水云游 <i class="ic i-at"><em>@</em></i>冴羽　逸秋</li><li class="link"><strong>Post link: </strong><a href="https://blog.issyuu.com/framework-distributed-transaction/" title="分布式事务总结">https://blog.issyuu.com/framework-distributed-transaction/</a></li><li class="license"><strong>Copyright Notice: </strong>All articles in this blog are licensed under <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC9kZWVkLnpo"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</span> unless stating additionally.</li></ul></div></footer></article></div><div class="post-nav"><div class="item left"><a href="/exp-db-data-pagination/" itemprop="url" rel="prev" data-background-image="https:&#x2F;&#x2F;cdn.jsdelivr.net&#x2F;gh&#x2F;smile-lxy&#x2F;resources@latest&#x2F;images&#x2F;random&#x2F;d57fb656daeae8c85814e95768e6cedf.md.jpg" title="分库分表后-数据分页"><span class="type">Previous Post</span> <span class="category"><i class="ic i-flag"></i> 经验</span><h3>分库分表后-数据分页</h3></a></div><div class="item right"><a href="/jvm-class-loader-mechanism/" itemprop="url" rel="next" data-background-image="https:&#x2F;&#x2F;cdn.jsdelivr.net&#x2F;gh&#x2F;smile-lxy&#x2F;resources@latest&#x2F;images&#x2F;random&#x2F;545e6f6f8db4a66e412bf2c5213d3d10.md.jpg" title="JVM类加载机制"><span class="type">Next Post</span> <span class="category"><i class="ic i-flag"></i> Jvm</span><h3>JVM类加载机制</h3></a></div></div><div class="wrap" id="comments"></div></div><div id="sidebar"><div class="inner"><div class="panels"><div class="inner"><div class="contents panel pjax" data-title="Contents"><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%AD%A3%E6%96%87"><span class="toc-number">2.</span> <span class="toc-text">正文</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%A4%E9%98%B6%E6%AE%B5%E6%8F%90%E4%BA%A42pc"><span class="toc-number">2.1.</span> <span class="toc-text">两阶段提交 (2PC)</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%87%86%E5%A4%87"><span class="toc-number">2.1.1.</span> <span class="toc-text">准备</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%8F%90%E4%BA%A4"><span class="toc-number">2.1.2.</span> <span class="toc-text">提交</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%BC%BA%E7%82%B9"><span class="toc-number">2.1.3.</span> <span class="toc-text">缺点</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%97%A0%E6%B3%95%E8%A7%A3%E5%86%B3%E7%9A%84%E9%97%AE%E9%A2%98"><span class="toc-number">2.1.4.</span> <span class="toc-text">无法解决的问题</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%BB%93%E6%9E%9C"><span class="toc-number">2.1.5.</span> <span class="toc-text">结果</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%89%E9%98%B6%E6%AE%B5%E6%8F%90%E4%BA%A43pc"><span class="toc-number">2.2.</span> <span class="toc-text">三阶段提交 (3PC)</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%8C%BA%E5%88%AB"><span class="toc-number">2.2.1.</span> <span class="toc-text">区别</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#cancommit"><span class="toc-number">2.2.2.</span> <span class="toc-text">CanCommit</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#precommit"><span class="toc-number">2.2.3.</span> <span class="toc-text">PreCommit</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#docommit"><span class="toc-number">2.2.4.</span> <span class="toc-text">DoCommit</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%B3%A8%E6%84%8F"><span class="toc-number">2.2.5.</span> <span class="toc-text">注意</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2pc%E4%B8%8E3pc%E5%8C%BA%E5%88%AB"><span class="toc-number">2.2.6.</span> <span class="toc-text">2PC 与 3PC 区别</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#base"><span class="toc-number">2.3.</span> <span class="toc-text">BASE</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#tcc"><span class="toc-number">2.4.</span> <span class="toc-text">TCC</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#try"><span class="toc-number">2.4.1.</span> <span class="toc-text">Try</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#confirm"><span class="toc-number">2.4.2.</span> <span class="toc-text">Confirm</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#cancel"><span class="toc-number">2.4.3.</span> <span class="toc-text">Cancel</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2pc%E4%B8%8Etcc%E5%8C%BA%E5%88%AB"><span class="toc-number">2.4.4.</span> <span class="toc-text">2PC 与 TCC 区别</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BC%98%E7%82%B9"><span class="toc-number">2.4.5.</span> <span class="toc-text">优点</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%BC%BA%E7%82%B9-2"><span class="toc-number">2.4.6.</span> <span class="toc-text">缺点</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%80%82%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="toc-number">2.4.7.</span> <span class="toc-text">适用场景</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#saga"><span class="toc-number">2.5.</span> <span class="toc-text">Saga</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E6%96%B9%E5%BC%8F"><span class="toc-number">2.5.1.</span> <span class="toc-text">实现方式</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%A1%A5%E5%81%BF%E7%AD%96%E7%95%A5"><span class="toc-number">2.5.2.</span> <span class="toc-text">补偿策略</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#acid"><span class="toc-number">2.5.3.</span> <span class="toc-text">ACID</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%A6%81%E6%B1%82"><span class="toc-number">2.5.4.</span> <span class="toc-text">要求</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%B3%A8%E6%84%8F-2"><span class="toc-number">2.5.5.</span> <span class="toc-text">注意</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%80%82%E7%94%A8%E5%9C%BA%E6%99%AF-2"><span class="toc-number">2.5.6.</span> <span class="toc-text">适用场景</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number">3.</span> <span class="toc-text">总结</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BE%AE%E6%9C%8D%E5%8A%A1"><span class="toc-number">3.1.</span> <span class="toc-text">微服务</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BC%95%E7%94%A8"><span class="toc-number">4.</span> <span class="toc-text">引用</span></a></li></ol></div><div class="related panel pjax" data-title="Related"><ul><li class="active"><a href="/framework-distributed-transaction/" rel="bookmark" title="分布式事务总结">分布式事务总结</a></li></ul></div><div class="overview panel" data-title="Overview"><div class="author" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="image" itemprop="image" alt="冴羽　逸秋" data-src="/images/avatar.jpg"><p class="name" itemprop="name">冴羽　逸秋</p><div class="description" itemprop="description">欲を捨てて、今を生きる！</div></div><nav class="state"><div class="item posts"><a href="/archives/"><span class="count">34</span> <span class="name">posts</span></a></div><div class="item categories"><a href="/categories/"><span class="count">19</span> <span class="name">categories</span></a></div><div class="item tags"><a href="/tags/"><span class="count">9</span> <span class="name">tags</span></a></div></nav><div class="social"><span class="exturl item github" data-url="aHR0cHM6Ly9naXRodWIuY29tL3NtaWxlLWx4eQ==" title="https:&#x2F;&#x2F;github.com&#x2F;smile-lxy"><i class="ic i-github"></i></span></div><ul class="menu"><li class="item"><a href="/" rel="section"><i class="ic i-home"></i>Home</a></li><li class="item dropdown"><a href="javascript:void(0);"><i class="ic i-feather"></i>Posts</a><ul class="submenu"><li class="item"><a href="/archives/" rel="section"><i class="ic i-list-alt"></i>Archives</a></li><li class="item"><a href="/categories/" rel="section"><i class="ic i-th"></i>Categories</a></li><li class="item"><a href="/tags/" rel="section"><i class="ic i-tags"></i>Tags</a></li></ul></li><li class="item"><a href="/friends/" rel="section"><i class="ic i-heart"></i>Friends</a></li></ul></div></div></div><ul id="quick"><li class="prev pjax"><a href="/exp-db-data-pagination/" rel="prev" title="Previous Post"><i class="ic i-chevron-left"></i></a></li><li class="up"><i class="ic i-arrow-up"></i></li><li class="down"><i class="ic i-arrow-down"></i></li><li class="next pjax"><a href="/jvm-class-loader-mechanism/" rel="next" title="Next Post"><i class="ic i-chevron-right"></i></a></li><li class="percent"></li></ul></div></div><div class="dimmer"></div></div></main><footer id="footer"><div class="inner"><div class="widgets"><div class="rpost pjax"><h2>Random Posts</h2><ul><li class="item"><div class="breadcrumb"><a href="/categories/%E6%8A%80%E6%9C%AF/" title="In 技术">技术</a> <i class="ic i-angle-right"></i> <a href="/categories/%E6%8A%80%E6%9C%AF/Java/" title="In Java">Java</a> <i class="ic i-angle-right"></i> <a href="/categories/%E6%8A%80%E6%9C%AF/Java/Jvm/" title="In Jvm">Jvm</a></div><span><a href="/jvm-carbage-collect/" title="Jvm垃圾回收">Jvm垃圾回收</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/%E6%97%A5%E6%9C%AC/" title="In 日本">日本</a> <i class="ic i-angle-right"></i> <a href="/categories/%E6%97%A5%E6%9C%AC/%E5%AD%A6%E4%B9%A0/" title="In 学习">学习</a> <i class="ic i-angle-right"></i> <a href="/categories/%E6%97%A5%E6%9C%AC/%E5%AD%A6%E4%B9%A0/%E6%97%A5%E8%AF%AD/" title="In 日语">日语</a></div><span><a href="/nihonngo-tanngo/" title="学习-日语-单词要点">学习-日语-单词要点</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/%E6%8A%80%E6%9C%AF/" title="In 技术">技术</a> <i class="ic i-angle-right"></i> <a href="/categories/%E6%8A%80%E6%9C%AF/%E7%BB%8F%E9%AA%8C/" title="In 经验">经验</a></div><span><a href="/exp-db-data-pagination/" title="分库分表后-数据分页">分库分表后-数据分页</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/%E6%97%A5%E6%9C%AC/" title="In 日本">日本</a> <i class="ic i-angle-right"></i> <a href="/categories/%E6%97%A5%E6%9C%AC/%E6%96%87%E7%AB%A0/" title="In 文章">文章</a> <i class="ic i-angle-right"></i> <a href="/categories/%E6%97%A5%E6%9C%AC/%E6%96%87%E7%AB%A0/%E6%97%A5%E8%AF%AD/" title="In 日语">日语</a></div><span><a href="/bunnsyou-mirainikitaidekiru-ja/" title="未来に期待できる">未来に期待できる</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/%E6%97%A5%E6%9C%AC/" title="In 日本">日本</a> <i class="ic i-angle-right"></i> <a href="/categories/%E6%97%A5%E6%9C%AC/%E5%AD%A6%E4%B9%A0/" title="In 学习">学习</a> <i class="ic i-angle-right"></i> <a href="/categories/%E6%97%A5%E6%9C%AC/%E5%AD%A6%E4%B9%A0/%E6%97%A5%E8%AF%AD/" title="In 日语">日语</a></div><span><a href="/fukushi-katarikuchi-koou/" title="学习-日语-副词(语气和呼应)">学习-日语-副词(语气和呼应)</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/%E6%97%A5%E6%9C%AC/" title="In 日本">日本</a> <i class="ic i-angle-right"></i> <a href="/categories/%E6%97%A5%E6%9C%AC/%E5%AD%A6%E4%B9%A0/" title="In 学习">学习</a> <i class="ic i-angle-right"></i> <a href="/categories/%E6%97%A5%E6%9C%AC/%E5%AD%A6%E4%B9%A0/%E6%97%A5%E8%AF%AD/" title="In 日语">日语</a></div><span><a href="/nihonngo-poinnto/" title="学习-日语-要点">学习-日语-要点</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/%E6%97%A5%E6%9C%AC/" title="In 日本">日本</a> <i class="ic i-angle-right"></i> <a href="/categories/%E6%97%A5%E6%9C%AC/%E5%AD%A6%E4%B9%A0/" title="In 学习">学习</a> <i class="ic i-angle-right"></i> <a href="/categories/%E6%97%A5%E6%9C%AC/%E5%AD%A6%E4%B9%A0/%E6%97%A5%E8%AF%AD/" title="In 日语">日语</a></div><span><a href="/fukushi-zokuseikeiyoushi/" title="学习-日语-属性形容词">学习-日语-属性形容词</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/%E6%97%A5%E6%9C%AC/" title="In 日本">日本</a> <i class="ic i-angle-right"></i> <a href="/categories/%E6%97%A5%E6%9C%AC/%E5%AD%A6%E4%B9%A0/" title="In 学习">学习</a> <i class="ic i-angle-right"></i> <a href="/categories/%E6%97%A5%E6%9C%AC/%E5%AD%A6%E4%B9%A0/%E6%97%A5%E8%AF%AD/" title="In 日语">日语</a></div><span><a href="/fukushi-fukugoudoushi/" title="学习-日语-复合动词">学习-日语-复合动词</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/%E6%8A%80%E6%9C%AF/" title="In 技术">技术</a> <i class="ic i-angle-right"></i> <a href="/categories/%E6%8A%80%E6%9C%AF/%E6%80%BB%E7%BB%93/" title="In 总结">总结</a></div><span><a href="/framework-distributed-transaction/" title="分布式事务总结">分布式事务总结</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/%E6%8A%80%E6%9C%AF/" title="In 技术">技术</a> <i class="ic i-angle-right"></i> <a href="/categories/%E6%8A%80%E6%9C%AF/Java/" title="In Java">Java</a> <i class="ic i-angle-right"></i> <a href="/categories/%E6%8A%80%E6%9C%AF/Java/Jvm/" title="In Jvm">Jvm</a></div><span><a href="/jvm-class-loader-mechanism/" title="JVM类加载机制">JVM类加载机制</a></span></li></ul></div><div><h2>Recent Comments</h2><ul class="leancloud-recent-comment"></ul></div></div><div class="status"><div class="copyright">&copy; 2020 – <span itemprop="copyrightYear">2023</span> <span class="with-love"><i class="ic i-sakura rotate"></i> </span><span class="author" itemprop="copyrightHolder">冴羽　逸秋 @ 湖心小筑</span></div><div class="count"><span class="post-meta-item-icon"><i class="ic i-chart-area"></i> </span><span title="Symbols count total">408k words</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="ic i-coffee"></i> </span><span title="Reading time total">6:11</span></div></div></div></footer></div><script data-config type="text/javascript">var LOCAL={path:"/framework-distributed-transaction/",favicon:{show:"（●´3｀●）Goooood",hide:"(´Д｀)Booooom"},search:{placeholder:"Search for Posts",empty:"We didn't find any results for the search: ${query}",stats:"${hits} results found in ${time} ms"},valine:!0,fancybox:!0,copyright:'Copied to clipboard successfully! <br> All articles in this blog are licensed under <i class="ic i-creative-commons"></i>BY-NC-SA.',ignores:[function(e){return e.includes("#")},function(e){return new RegExp(LOCAL.path+"$").test(e)}]}</script><script src="https://cdn.polyfill.io/v2/polyfill.js"></script><script src="//cdn.jsdelivr.net/combine/npm/pace-js@1.0.2/pace.min.js,npm/pjax@0.2.8/pjax.min.js,npm/whatwg-fetch@3.4.0/dist/fetch.umd.min.js,npm/animejs@3.2.0/lib/anime.min.js,npm/algoliasearch@4/dist/algoliasearch-lite.umd.js,npm/instantsearch.js@4/dist/instantsearch.production.min.js,npm/lozad@1/dist/lozad.min.js,npm/quicklink@2/dist/quicklink.umd.js"></script><script src="/js/app.js?v=0.2.5"></script></body></html>